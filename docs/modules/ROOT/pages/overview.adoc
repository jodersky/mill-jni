# mill-jni

Some mill plugins to ease working with Java's Native Interface (JNI).

This includes two modules:

- <<jnilib.JavahModule>>
- <<jnilib.CLibModule>>

## jnilib.JavahModule

This module implements C header generation from methods declared as `native` in
your Scala or Java code. It provides a `javah` command, which is similar to the
command line tool that used to be shipped with JDK distributions, but works on
any classfile (instead of requiring Java source code), and is based on the
link:https://github.com/Glavo/gjavah[gjavah library by Glavo].

### Module

Assuming a project with the following sourcefile and build definition:

```scala
package example

class NativeWrapper {
  @native def fun(): Int
}
```

```scala
import TODO
import jnilib.JavahModule

object app extends ScalaModule with JavahModule {
  def scalaVersion = "3.0.0-RC3"
}
```

C/C++ header files for the native method can be generated by running:

```
mill app.javah
```

This will generate the below header file in `src/app/example/NativeWrapper.h`.

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class example/NativeWrapper */

#ifndef _Included_example_NativeWrapper
#define _Included_example_NativeWrapper
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:      example/NativeWrapper
 * Method:     fun
 * Signature:  ()I
 */
JNIEXPORT jint JNICALL Java_example_NativeWrapper_fun
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

One header file will be created per class, and will be saved in the source
directory under a relative path name corresponding to the class' package. For
example, class `foo.bar.Wrapper` will be generated in `src/foo/bar/Wrapper.h`.
The base directory is configurable by overriding the `javahOutputDirectory`
target.

### jnilib.JavahModule/findIncludes

The `jnilib.JavahModule` companion object has a method to look up the include
paths of the system-wide JNI header files.

```
mill show jnilib.JavahModule/findIncludes

[
    "/usr/lib/jvm/java-11-openjdk-amd64/include",
    "/usr/lib/jvm/java-11-openjdk-amd64/include/linux"
]
```

This can be used to resolve `#include <jni.h>` when it comes to compiling the
C/C++ library.

## jnilib.CLibModule

The `CLibModule` wraps a C/C++ compiler toolchain (e.g. `gcc` or `clang`) to
build a native library. This module is often used in conjuction with
<<jnilib.JavahModule>> to build the native backend within the same project.
